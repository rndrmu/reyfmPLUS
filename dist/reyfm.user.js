// ==UserScript==
// @name         reyfm-plus
// @namespace    https://github.com
// @version      1.0.0
// @description  ReyFM++
// @author       
// @match        https://rey.fm/*
// @grant        none
// ==/UserScript==
(()=>{var d=class{constructor(t,e="white"){this.name=t;this.color=e}static makeTitle(t,e){return["%c %c %s ","",`background: ${t}; color: black; font-weight: bold; border-radius: 5px;`,e]}_log(t,e,o,a=""){console[t](`%c Rey.fm Plus %c %c ${this.name} ${a}`,`background: ${e}; color: black; font-weight: bold; border-radius: 5px;`,"",`background: ${this.color}; color: black; font-weight: bold; border-radius: 5px;`,...o)}log(...t){this._log("log","#a6d189",t)}info(...t){this._log("info","#a6d189",t)}error(...t){this._log("error","#e78284",t)}errorCustomFmt(t,...e){this._log("error","#e78284",e,t)}warn(...t){this._log("warn","#e5c890",t)}debug(...t){this._log("debug","#eebebe",t)}};var L={original:1,nightlife:2,raproyal:3,usrap:4,hitsonly:5,gaming:6,houseparty:7,chillout:8,lofi:9,oldschool:10,mashup:11,charts:12,partyhard:13,bass:14,kpop:15,xmas:20};function p(n){return n}var w=new d("core/Observer");function y(n,t){new MutationObserver((e,o)=>{let a=document.querySelectorAll(n)[0];a&&a.offsetParent!==null&&(t(a),o.disconnect())}).observe(document,{childList:!0,subtree:!0})}var X=()=>{window.addEventListener("popstate",()=>{w.log("Path changed to "+window.location.pathname),x(window.location.pathname)})},q=()=>{window.$nuxt.$watch(()=>window.$nuxt.$store.state.player.volume,n=>{window.rfmPlus.state.audioPlayer&&(window.rfmPlus.state.audioPlayer.volume=n/100)})},x=n=>{w.log("New path: "+n);let t=window.rfmPlus.plugins;for(let[,e]of t)e.pathConstraint&&n.match(e.pathConstraint)&&e.enabled&&(w.log("Enabling plugin: "+e.name),e.injectTarget&&(w.log("Waiting for element to be visible"),y(e.injectTarget,()=>{e.entrypoint()})))},R=[{name:"pathObserver",associatedFn:X,enabled:!0},{name:"volumeObserver",associatedFn:q,enabled:!0}];function $(n,t,e,o,a){let r=n.cloneNode(!0);return r.childNodes[0].textContent=t,r.style.backgroundColor=e,r.style.color="#ffffff",r.style.marginTop=o?"10px":"0px",r.style.paddingLeft="10px",r.style.paddingRight="10px",r.style.borderRadius="10px",r.style.fontSize="12px",r.addEventListener("click",a),r}function M(){let n=document.querySelectorAll("p[data-v-5fde3039]")[0].textContent?.trim(),t=document.querySelectorAll("p[data-v-5fde3039]")[1].textContent?.trim(),e=`https://open.spotify.com/search/${n} ${t}`;window.open(e,"_blank")}function O(){let n=document.querySelectorAll("div.base-container")[4],e=n.childNodes[2].cloneNode(!0);e.childNodes[0].textContent="ReyfmPlus",e.querySelector("div > a > p").textContent=`A script to enhance the rey.fm experience

 Version: 1.0`,e.querySelector("div > a > p").innerHTML=e.querySelector("div > a > p").innerHTML.replace(/\n/g,"<br>"),e.querySelector("div > a").removeAttribute("href"),n.insertBefore(e,n.childNodes[5])}function m(n){window.__NUXT__.state.player.audio.pause(),window.__NUXT__.state.player.audio=null,window.__NUXT__.state.player.audio=n,window.__NUXT__.state.player.audio?.play()}function P(n,t){let e=window.__NUXT__.state.player.audio;window.__NUXT__.state.player.currentStation=n,e.src=`https://listen.reyfm.de/${n}_${t}kbps.mp3`,e.play()}var S={state:{bassBoostActive:!1,bassBoostLevel:0,audioContext:void 0,audioPlayer:void 0},api:{getStation:async n=>{let t=await window.rfmPlus.api.getStations();return L[n]},getStations:async()=>new Promise((n,t)=>{let e=window.__NUXT__.state.main.data.channels;e?n(e):t("Could not get stations")}),playBoosted:async(n,t)=>{window.__NUXT__.state.player.audio&&m(window.rfmPlus.state.audioPlayer),window.rfmPlus.state.bassBoostActive=!0,P(n,t)},playOriginal:async(n,t)=>{window.__NUXT__.state.player.audio&&m(window.rfmPlus.state.audioPlayer),window.rfmPlus.state.bassBoostActive=!1,P(n,t)}},plugins:new Map};var ve=new d("Plugins/BassBoost"),T=p({name:"Bass Boost",enabled:!0,author:"built-in",version:"1.0.0",description:"Adds a bass boost button to the player",awaitElementVisible:null,entrypoint:()=>{let n=document.createElement("button");n.className="btn btn-primary btn-sm",n.innerHTML="Bass Boost",n.addEventListener("click",()=>{let t=document.querySelector("audio");t&&(t.playbackRate=1.5)}),document.querySelector(".player-controls").appendChild(n)}});var g=(n,t,e=!1,o="info")=>{let a=document.querySelector("body"),r=document.createElement("div");r.className="fmplus notification";let i={position:"fixed",right:"0",width:"fit-content",maxWidth:"50%",minWidth:"25rem",margin:"0.5rem",padding:"0.5rem",backgroundColor:"rgba(255, 255, 255, 0.1)",backdropFilter:"blur(10px)",borderRadius:"0.25rem",color:"#fff",textAlign:"center",zIndex:"9999"},s=document.querySelectorAll(".fmplus.notification");if(s.length>0){let h=s[s.length-1].getBoundingClientRect();i.top=`${h.top+h.height+10}px`}else i.top="0";Object.assign(r.style,i);let l=document.createElement("h3");l.className="fmplus notification-title",l.innerHTML=n;let c={top:"0",left:"0",margin:"0",padding:"0",fontSize:"1.5rem",fontWeight:"bold"};Object.assign(l.style,c);let b=document.createElement("p");b.className="fmplus notification-message";let D={textAlign:"left",margin:"0",padding:"0"};return Object.assign(b.style,D),b.innerHTML=t,r.appendChild(l),r.appendChild(b),r.animate([{transform:"translateY(-100%)"},{transform:"translateY(0)"}],{duration:500,easing:"ease-in-out"}),a.appendChild(r),e||setTimeout(()=>{r.animate([{transform:"translateY(0)"},{transform:"translateY(-100%)"}],{duration:500,easing:"ease-in-out"}).onfinish=()=>{r.remove()}},5e3),r.addEventListener("click",()=>{r.animate([{transform:"translateY(0)"},{transform:"translateY(-100%)"}],{duration:500,easing:"ease-in-out"}).onfinish=()=>{r.remove()};let _=document.querySelectorAll(".fmplus.notification"),h=Array.from(_).indexOf(r);Array.from(_).slice(h+1).forEach(A=>{let v=A.getBoundingClientRect();A.animate([{transform:`translateY(${v.top}px)`},{transform:`translateY(${v.top-65}px)`}],{duration:500,easing:"ease-in-out"}),i.top=`${v.top-65}px`})}),r},B=n=>{let t=document.querySelector("body"),e=document.createElement("div");e.className="fmplus toast";let o=document.querySelectorAll(".fmplus.toast");if(o.length>0){let i=o[o.length-1].getBoundingClientRect();e.style.bottom=`${i.top+10}px`,e.style.top="unset"}else e.style.bottom="0";e.style.position="fixed",e.style.left="0",e.style.width="100%",e.style.margin="1.5rem",e.style.padding="1.5rem",e.style.backgroundColor="rgba(22, 24, 25, 0.8)",e.style.backdropFilter="blur(10px)",e.style.borderRadius="0.25rem",e.style.color="#fff",e.style.textAlign="center",e.style.zIndex="9999";let a=document.createElement("p");return a.className="fmplus notification-message",a.style.textAlign="center",a.style.margin="0",a.style.padding="0",a.style.fontSize="1.5rem",a.style.fontWeight="bold",a.innerHTML=n,e.animate([{opacity:0,transform:"translateY(100%)"},{opacity:1,transform:"translateY(0)"}],{duration:500,easing:"ease-in-out"}),e.appendChild(a),t.appendChild(e),setTimeout(()=>{e.animate([{opacity:1,transform:"translateY(0)"},{opacity:0,transform:"translateY(100%)"}],{duration:500,easing:"ease-in-out"}).onfinish=()=>{e.remove()}},5e3),e.addEventListener("click",()=>{e.animate([{opacity:1,transform:"translateY(0)"},{opacity:0,transform:"translateY(100%)"}],{duration:500,easing:"ease-in-out"}).onfinish=()=>{e.remove()};let r=document.querySelectorAll(".fmplus.toast"),i=Array.from(r).indexOf(e);Array.from(r).slice(i+1).forEach(l=>{let c=l.getBoundingClientRect();l.animate([{transform:`translateY(${c.top}px)`},{transform:`translateY(${c.top+65}px)`}],{duration:500,easing:"ease-in-out"}),l.style.top=`${c.top+65}px`})}),e};var u=new d("Plugins/RankingSystem"),C=p({name:"Ranking System",enabled:!0,author:"built-in",version:"1.0.0",description:"Adds a ranking system to the player",awaitElementVisible:null,entrypoint:()=>{let n=new WebSocket("ws://localhost:8080"),t=Date.now();n.addEventListener("open",()=>{u.info("Socket connection established")}),n.addEventListener("message",a=>{switch(a.data.type){case"heartbeatACK":u.info("Received heartbeat ACK");break;case"LevelUpBroadcast":B(`User ${a.data.data.username} has leveled up to level ${a.data.data.level}!`);break;default:u.warn("Received unknown message type: %s",a.data.type);break}}),n.addEventListener("close",a=>{u.info("Socket connection closed. Code: %s, Reason: %s",a.code,a.reason),clearInterval(e),clearInterval(o)}),n.addEventListener("error",a=>{u.error(a)});let e=setInterval(()=>{u.info("Sending heartbeat"),Date.now()-t>3e4&&(u.error("Heartbeat timeout exceeded. Closing socket connection."),g("Heartbeat timeout exceeded. Closing socket connection.","",!1,"error"),n.close(4e3,"Heartbeat timeout")),n.send(JSON.stringify({type:"heartbeat",data:{timestamp:Date.now()}}))},15e3),o=setInterval(()=>{u.info("Sending play state update"),n.send(JSON.stringify({type:"PlayStateUpdate",data:{timestamp:Date.now(),discord_id:12345679e12,channel_id:"1",listening_delta:30}}))},3e4)}});var E=new d("Plugins/SleepTimer"),N=p({name:"Sleep Timer",enabled:!0,description:"Automatically stops playback after a set amount of time",version:"1.0.0",author:"built-in",pathConstraint:RegExp("/station/"),injectTarget:"div.name",entrypoint:()=>{let n=document.querySelector("div.space-y-1[data-v-5946bf68]"),t=document.createElement("button");t.className="fmplus sleep-timer-button";let e={width:"100px",margin:"0.25rem",backgroundColor:"#1e1e1e",color:"#fff",border:"1px solid #1e1e1e",borderRadius:"0.25rem",padding:"0.25rem",fontSize:"12px",fontWeight:"bold",textAlign:"center",cursor:"pointer",lineHeight:"1.5"};Object.assign(t.style,e),t.innerHTML="Sleep Timer",t.addEventListener("click",()=>{let o=document.createElement("div");o.className="fmplus sleep-timer-menu";let a={backgroundColor:"rgba(255, 255, 255, 0.2)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.3)",zIndex:"9999",display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column",padding:"1rem",boxSizing:"border-box",cursor:"pointer",position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)"};Object.assign(o.style,a),o.addEventListener("click",i=>{if(i.stopPropagation(),i.target!==o){o.remove();return}}),[{label:"30 minutes",value:30},{label:"1 hour",value:60},{label:"2 hours",value:120},{label:"4 hours",value:240},{label:"8 hours",value:480},{label:"12 hours",value:720},{label:"24 hours",value:1440},{label:"Exit",value:"0"}].forEach(i=>{let s=document.createElement("button"),l={backgroundColor:"rgba(255, 255, 255, 0.2)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.3)",borderRadius:"0.25rem",padding:"0.5rem",margin:"0.25rem",fontSize:"12px",fontWeight:"bold",textAlign:"center",cursor:"pointer",lineHeight:"1.5",minWidth:"250px",color:"#fff"};Object.assign(s.style,l),s.innerHTML=i.label,s.addEventListener("click",c=>{if(c.stopPropagation(),i.value==="0"){o.remove();return}E.info(`Sleep timer started for ${i.value} minutes`),Y(Number(i.value)),E.info("Sleep timer menu closed"),g(`Sleep timer started for ${i.value} minutes`,"Sleep Timer",!1,"info")}),o.appendChild(s)}),document.body.appendChild(o)}),n.appendChild(t)}});async function Y(n){let e=g(`Sleep timer started for ${n} minutes`,"Sleep Timer",!0,"info").querySelector("p.fmplus.notification-message"),o=n*60,a=new Date().getTime()+o*1e3,r=setInterval(()=>{if(o===0){clearInterval(r),e.innerHTML="Sleep timer engaged. Good night!",window.__NUXT__.state.player.audio.pause(),window.__NUXT__.state.player.playing=!1,window.__NUXT__.state.player.audio=null,window.rfmPlus.state.audioPlayer.pause(),window.rfmPlus.state.audioPlayer=null;return}o--,E.debug("Time remaining",o);let i=Math.floor(o/3600),s=Math.floor((o-i*3600)/60),l=o-i*3600-s*60;i<10&&(i="0"+i),s<10&&(s="0"+s),l<10&&(l="0"+l),e.innerHTML=`Time remaining: ${i}:${s}:${l}`},1e3)}var f=new Map;f.set(T.name,T);f.set(C.name,C);f.set(N.name,N);function H(){Array.from(document.querySelectorAll("div.station-small")).forEach(n=>{U(n.__vue__)}),U(document.querySelector("div.fixed[data-v-5fde3039]").__vue__)}function k(n){window.__NUXT__.state.player.playing=n,window.$nuxt.$store.state.player.playing=n}function j(n){window.__NUXT__.state.player.currentStation=n}function W(n){window.rfmPlus.state.audioPlayer=n}function U(n){let t=new d("rfmplus/core");n.playerTogglePlay=function(e){console.log(this);let o=window.$nuxt.$store.state.player.playing||!1;if(t.debug(`Toggling play for station ${e} (isPlaying: ${o})`),o){if(this.playerStop(e),String(window.__NUXT__.state.player.currentStation)===e)return;this.play(e)}else this.play(e)},n.play=function(e){j(e);let o=new Audio;o.src=window.__NUXT__.state.main.data.channels[e].stream_urls.high,o.volume=Number(window.$nuxt.$store.state.player.volume)/100,W(o),k(!0),window.rfmPlus.state.audioPlayer.play()},n.playerStop=function(e=window.__NUXT__.state.player.currentStation){let o=this.$vnode.key?this.$vnode.key:window.__NUXT__.state.player.currentStation;t.debug(`Stopping player for station ${o}`),k(!1),t.debug("Pausing custom audio playe"),window.rfmPlus.state.audioPlayer.pause(),t.debug("Setting audio player to null"),window.rfmPlus.state.audioPlayer=null},n.playerPlay=function(e=window.__NUXT__.state.player.currentStation){let o=this.$vnode.key?this.$vnode.key:window.__NUXT__.state.player.currentStation;t.debug(`Playing station ${o}`),k(!0),window.rfmPlus.state.audioPlayer.play()}}y("div[data-v-733b83fc] > a > svg",n=>{z()});function z(){let n=new d("Loader");n.info("Hello from ReyfmPlus!"),R.forEach(t=>{if(t.enabled){n.info(`Loading observer: ${t.name}`);try{t.associatedFn()}catch(e){n.error(`Error while loading observer ${t.name}: ${e}`)}}}),f.forEach(t=>{if(t.enabled){n.info(`Loading plugin: ${t.name}`);try{t.injectTarget&&(document.querySelector(t.injectTarget)?(n.info(`Plugin ${t.name} has a dependent element ${t.injectTarget} which has already been loaded. Loading plugin...`),t.entrypoint()):(n.info(`Plugin ${t.name} has a dependent element ${t.injectTarget} which has not been loaded yet. Waiting for it to load...`),y(t.injectTarget,t.entrypoint))),t.entrypoint()}catch(e){n.error(`Error while loading plugin ${t.name}: ${e}`)}}}),S.plugins=f,window.rfmPlus=window.rfmPlus||S,O(),x(window.location.pathname),y("div.station-small",t=>{let o=t.parentElement?.parentElement,a=$(t,"On Spotify","#1db954",!1,r=>{r.preventDefault(),M()});o.appendChild(a)}),n.info("Injecting player controls"),H()}function je(){window.__NUXT__.state.player.audio&&m(window.rfmPlus.state.audioPlayer);let n=location.pathname.split("/")[2],t=V[n];console.log("[REYFMPLUS] Station ID: "+t),console.log("[REYFMPLUS] Bass boost menu for station: "+n),window.__NUXT__.state.player.currentStation=t;let e=`https://listen.reyfm.de/${n}_320kbps.mp3`,o=document.createElement("div");o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.backgroundColor="rgba(0, 0, 0, 0.5)";let a=document.createElement("div");a.style.position="absolute",a.style.top="50%",a.style.left="50%",a.style.transform="translate(-50%, -50%)",a.style.backgroundColor="#ffffff",a.style.padding="20px",a.style.borderRadius="10px",a.style.width="80%",a.style.maxWidth="500px",a.style.height="80%",a.style.maxHeight="500px",a.style.overflow="auto",a.style.boxShadow="0 0 10px 0 rgba(0, 0, 0, 0.5)",a.textContent="REYFMPlus \u2014 Bass Boost Menu",a.style.fontSize="20px",a.style.fontWeight="bold",a.style.textAlign="center",a.style.marginBottom="20px",document.body.appendChild(o),o.appendChild(a),[{name:"Normal",description:"No bass boost",value:0},{name:"Regular Bass Boost",description:"A regular bass boost, nothing fancy",value:1},{name:"Heavy Bass Boost",description:"A heavy bass boost, for the bassheads",value:5},{name:"Bass Boost + Limiter",description:"A regular bass boost with a limiter to prevent clipping",value:3},{name:"Absolutely fucking crazy",description:"A heavy bass boost, why are you even using this",value:15}].forEach(i=>{let s=document.createElement("div");s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.marginBottom="20px",s.style.cursor="pointer";let l=document.createElement("div");l.style.fontSize="18px",l.style.fontWeight="bold",l.textContent=i.name;let c=document.createElement("div");c.style.fontSize="14px",c.style.fontWeight="normal",c.style.textAlign="center",c.textContent=i.description,s.appendChild(l),s.appendChild(c),s.addEventListener("click",()=>{Q(e,i.value),o.remove()}),a.appendChild(s)}),o.style.display="block",o.addEventListener("click",i=>{i.target===o&&o.remove()})}var V={original:1,nightlife:2,raproyal:3,usrap:4,hitsonly:5,gaming:6,houseparty:7,chillout:8,lofi:9,oldschool:10,mashup:11,charts:12,partyhard:13,bass:14,kpop:15,xmas:20};function Q(n="https://listen.reyfm.de/original_320kbps.mp3",t=1){let e=new window.AudioContext,o=new Audio;o.src=n,o.crossOrigin="anonymous";let a=e.createMediaElementSource(o),r=e.createBiquadFilter();r.type="lowshelf",r.frequency.value=1e3,r.gain.value=t,a.connect(r),r.connect(e.destination),window.__NUXT__.state.player.playing=!0,window.__NUXT__.state.player.audio&&m(o),window.rfmPlus.state.audioPlayer=o,window.rfmPlus.state.audioContext=e,window.__NUXT__.state.player.audio=o,playStateObserver(o)}})();
/*! For license information please see reyfm.user.js.LEGAL.txt */
