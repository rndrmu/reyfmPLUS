// ==UserScript==
// @name         reyfm-plus
// @namespace    https://github.com
// @version      1.0.0
// @description  ReyFM++
// @author       
// @match        https://rey.fm/*
// @grant        none
// ==/UserScript==
(()=>{function g(n,e,t,a,i){let o=n.cloneNode(!0);return o.childNodes[0].textContent=e,o.style.backgroundColor=t,o.style.color="#ffffff",o.style.marginTop=a?"10px":"0px",o.style.paddingLeft="10px",o.style.paddingRight="10px",o.style.borderRadius="10px",o.style.fontSize="12px",o.addEventListener("click",i),o}function m(n,e){new MutationObserver((t,a)=>{let i=document.querySelectorAll(n)[0];i&&i.offsetParent!==null&&(e(i),a.disconnect())}).observe(document,{childList:!0,subtree:!0})}function L(){let n=document.querySelectorAll("p[data-v-5fde3039]")[0].textContent?.trim(),e=document.querySelectorAll("p[data-v-5fde3039]")[1].textContent?.trim(),t=`https://open.spotify.com/search/${n} ${e}`;window.open(t,"_blank")}function k(){let n=document.querySelectorAll("div.base-container")[4],t=n.childNodes[2].cloneNode(!0);t.childNodes[0].textContent="ReyfmPlus",t.querySelector("div > a > p").textContent=`A script to enhance the rey.fm experience

 Version: 1.0`,t.querySelector("div > a > p").innerHTML=t.querySelector("div > a > p").innerHTML.replace(/\n/g,"<br>"),t.querySelector("div > a").removeAttribute("href"),n.insertBefore(t,n.childNodes[5])}function p(n){window.__NUXT__.state.player.audio.pause(),window.__NUXT__.state.player.audio=null,window.__NUXT__.state.player.audio=n,window.__NUXT__.state.player.audio?.play()}function R(n){p(window.__NUXT__.state.player.audio),window.__NUXT__.state.player.audio=n,window.__NUXT__.state.player.playing=!0,window.__NUXT__.state.player.audio.play()}function A(n,e){let t=window.location.pathname;new MutationObserver((a,i)=>{window.location.pathname!==t&&(t=window.location.pathname,h(t))}).observe(document,{childList:!0,subtree:!0})}function h(n){console.log("[REYFMPLUS] New path: "+n),n.startsWith("/station/")&&m("div.name",e=>{let t=e.parentElement,a=e;a.childNodes[0].textContent=a.childNodes[0].textContent+" \u2014 ReyfmPlusEnhanced";let i=g(e,"Bass Boost Menu","#ff0000",!0,()=>{console.log("clicked boost chip"),B()});if(t.appendChild(i),!window.rfmPlus.state.bassBoostActive){let o=g(e,"Bass Boost Active (Lvl: "+window.rfmPlus.state.bassBoostLevel+")","#ff0000",!0,()=>{console.log("clicked boost active chip")});t.appendChild(o)}})}function x(n,e){let t=window.__NUXT__.state.player.audio;window.__NUXT__.state.player.currentStation=n,t.src=`https://listen.reyfm.de/${n}_${e}kbps.mp3`,t.play()}var M={original:1,nightlife:2,raproyal:3,usrap:4,hitsonly:5,gaming:6,houseparty:7,chillout:8,lofi:9,oldschool:10,mashup:11,charts:12,partyhard:13,bass:14,kpop:15,xmas:20};function u(n){return n}var P={state:{bassBoostActive:!1,bassBoostLevel:0},api:{getStation:async n=>{let e=await window.rfmPlus.api.getStations();return M[n]},getStations:async()=>new Promise((n,e)=>{let t=window.__NUXT__.state.main.data.channels;t?n(t):e("Could not get stations")}),playBoosted:async(n,e)=>{window.__NUXT__.state.player.audio&&p(window.rfmPlus.state.audioPlayer),window.rfmPlus.state.bassBoostActive=!0,x(n,e)},playOriginal:async(n,e)=>{window.__NUXT__.state.player.audio&&p(window.rfmPlus.state.audioPlayer),window.rfmPlus.state.bassBoostActive=!1,x(n,e)}},plugins:new Map};var d=class{constructor(e,t="white"){this.name=e;this.color=t}static makeTitle(e,t){return["%c %c %s ","",`background: ${e}; color: black; font-weight: bold; border-radius: 5px;`,t]}_log(e,t,a,i=""){console[e](`%c Rey.fm Plus %c %c ${this.name} ${i}`,`background: ${t}; color: black; font-weight: bold; border-radius: 5px;`,"",`background: ${this.color}; color: black; font-weight: bold; border-radius: 5px;`,...a)}log(...e){this._log("log","#a6d189",e)}info(...e){this._log("info","#a6d189",e)}error(...e){this._log("error","#e78284",e)}errorCustomFmt(e,...t){this._log("error","#e78284",t,e)}warn(...e){this._log("warn","#e5c890",e)}debug(...e){this._log("debug","#eebebe",e)}};var ue=new d("Plugins/BassBoost"),E=u({name:"Bass Boost",enabled:!0,author:"built-in",version:"1.0.0",description:"Adds a bass boost button to the player",awaitElementVisible:null,entrypoint:()=>{let n=document.createElement("button");n.className="btn btn-primary btn-sm",n.innerHTML="Bass Boost",n.addEventListener("click",()=>{let e=document.querySelector("audio");e&&(e.playbackRate=1.5)}),document.querySelector(".player-controls").appendChild(n)}});var y=new d("Plugins/RankingSystem"),S=u({name:"Ranking System",enabled:!0,author:"built-in",version:"1.0.0",description:"Adds a ranking system to the player",awaitElementVisible:null,entrypoint:()=>{let n=new WebSocket("ws://localhost:8080");n.addEventListener("open",()=>{y.info("Socket connection established")}),n.addEventListener("message",a=>{let i=JSON.parse(a.data);y.info(i)}),n.addEventListener("close",a=>{y.info("Socket connection closed. Code: %s, Reason: %s",a.code,a.reason),clearInterval(e),clearInterval(t)}),n.addEventListener("error",a=>{y.error(a)});let e=setInterval(()=>{y.info("Sending heartbeat"),n.send(JSON.stringify({type:"heartbeat",data:{timestamp:Date.now()}}))},15e3),t=setInterval(()=>{y.info("Sending play state update"),n.send(JSON.stringify({type:"PlayStateUpdate",data:{timestamp:Date.now(),discord_id:12345679e12,channel_id:"1",listening_delta:30}}))},3e4)}});var C=(n,e,t=!1,a="info")=>{let i=document.querySelector("body"),o=document.createElement("div");o.className="fmplus notification";let r=document.querySelectorAll(".fmplus.notification");if(r.length>0){let w=r[r.length-1].getBoundingClientRect();o.style.top=`${w.bottom+15}px`}else o.style.top="0";o.style.position="fixed",o.style.right="0",o.style.width="fit-content",o.style.maxWidth="50%",o.style.minWidth="25rem",o.style.margin="0.5rem",o.style.padding="0.5rem",o.style.backgroundColor=a==="error"?"rgba(255, 0, 0, 0.2)":a==="info"?"rgba(0, 0, 255, 0.2)":a==="success"?"rgba(0, 255, 0, 0.2)":a==="warning"?"rgba(255, 255, 0, 0.2)":"rgba(255, 255, 255, 0.2)",o.style.backdropFilter="blur(10px)",o.style.borderRadius="0.25rem",o.style.color="#fff",o.style.textAlign="center",o.style.zIndex="9999";let s=document.createElement("h3");s.className="fmplus notification-title",s.style.top="0",s.style.left="0",s.style.margin="0",s.style.padding="0",s.style.fontSize="1.5rem",s.style.fontWeight="bold",s.innerHTML=n;let l=document.createElement("p");return l.className="fmplus notification-message",l.style.textAlign="left",l.style.margin="0",l.style.padding="0",l.innerHTML=e,o.appendChild(s),o.appendChild(l),o.animate([{transform:"translateY(-100%)"},{transform:"translateY(0)"}],{duration:500,easing:"ease-in-out"}),i.appendChild(o),t||setTimeout(()=>{o.animate([{transform:"translateY(0)"},{transform:"translateY(-100%)"}],{duration:500,easing:"ease-in-out"}).onfinish=()=>{o.remove()}},5e3),o.addEventListener("click",()=>{o.animate([{transform:"translateY(0)"},{transform:"translateY(-100%)"}],{duration:500,easing:"ease-in-out"}).onfinish=()=>{o.remove()};let c=document.querySelectorAll(".fmplus.notification"),w=Array.from(c).indexOf(o);Array.from(c).slice(w+1).forEach(_=>{let v=_.getBoundingClientRect();_.animate([{transform:`translateY(${v.top}px)`},{transform:`translateY(${v.top-65}px)`}],{duration:500,easing:"ease-in-out"}),_.style.top=`${v.top-65}px`})}),o};var T=new d("Plugins/SleepTimer"),N=u({name:"Sleep Timer",enabled:!0,description:"Automatically stops playback after a set amount of time",version:"1.0.0",author:"built-in",pathConstraint:RegExp("/station/"),injectTarget:"div.name",entrypoint:()=>{let n=document.querySelector("div.space-y-1[data-v-5946bf68]"),e=document.createElement("button");e.className="fmplus sleep-timer-button",e.style.width="100px",e.style.margin="0.25rem",e.style.backgroundColor="#1e1e1e",e.style.color="#fff",e.style.border="1px solid #1e1e1e",e.style.borderRadius="0.25rem",e.style.padding="0.25rem",e.style.fontSize="12px",e.style.fontWeight="bold",e.style.textAlign="center",e.style.cursor="pointer",e.style.lineHeight="1.5",e.innerHTML="Sleep Timer",e.addEventListener("click",()=>{let t=document.createElement("div");t.className="fmplus sleep-timer-menu",t.style.backgroundColor="rgba(255, 255, 255, 0.2)",t.style.backdropFilter="blur(10px)",t.style.border="1px solid rgba(255, 255, 255, 0.3)",t.style.zIndex="9999",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.flexDirection="column",t.style.padding="1rem",t.style.boxSizing="border-box",t.style.cursor="pointer",t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.addEventListener("click",i=>{if(i.stopPropagation(),i.target!==t){t.remove();return}}),[{label:"30 minutes",value:30},{label:"1 hour",value:60},{label:"2 hours",value:120},{label:"4 hours",value:240},{label:"8 hours",value:480},{label:"12 hours",value:720},{label:"24 hours",value:1440},{label:"Exit",value:"0"}].forEach(i=>{let o=document.createElement("button");o.style.backgroundColor="rgba(255, 255, 255, 0.2)",o.style.backdropFilter="blur(10px)",o.style.border="1px solid rgba(255, 255, 255, 0.3)",o.style.borderRadius="0.25rem",o.style.padding="0.5rem",o.style.margin="0.25rem",o.style.fontSize="12px",o.style.fontWeight="bold",o.style.textAlign="center",o.style.cursor="pointer",o.style.lineHeight="1.5",o.style.minWidth="250px",o.style.color="#fff",o.innerHTML=i.label,o.addEventListener("click",r=>{if(r.stopPropagation(),i.value==="0"){t.remove();return}T.info(`Sleep timer started for ${i.value} minutes`),$(Number(i.value)),T.info("Sleep timer menu closed"),C(`Sleep timer started for ${i.value} minutes`,"Sleep Timer",!1,"info")}),t.appendChild(o)}),document.body.appendChild(t)}),n.appendChild(e)}});async function $(n){let t=C(`Sleep timer started for ${n} minutes`,"Sleep Timer",!0,"info").querySelector("p.fmplus.notification-message"),a=n*60,i=new Date().getTime()+a*1e3,o=setInterval(()=>{if(a===0){clearInterval(o),t.innerHTML="Sleep timer engaged. Good night!",window.__NUXT__.state.player.audio.pause(),window.__NUXT__.state.player.playing=!1,window.__NUXT__.state.player.audio=null,window.rfmPlus.state.audioPlayer.pause(),window.rfmPlus.state.audioPlayer=null;return}a--,T.debug("Time remaining",a);let r=Math.floor(a/3600),s=Math.floor((a-r*3600)/60),l=a-r*3600-s*60;r<10&&(r="0"+r),s<10&&(s="0"+s),l<10&&(l="0"+l),t.innerHTML=`Time remaining: ${r}:${s}:${l}`},1e3)}var f=new Map;f.set(E.name,E);f.set(S.name,S);f.set(N.name,N);var O="div.inset-center > div.buttonShine";var b=new d("Observer"),F=()=>{let n=window.location.pathname;new MutationObserver((e,t)=>{window.location.pathname!==n&&(n=window.location.pathname,X(n))}).observe(document,{childList:!0,subtree:!0})},I=()=>{document.querySelector(O).addEventListener("click",()=>{H()})},X=n=>{b.log("New path: "+n);let e=window.rfmPlus.plugins;for(let[,t]of e)t.pathConstraint&&n.match(t.pathConstraint)&&(b.log("Enabling plugin: "+t.name),t.injectTarget&&(b.log("Waiting for element to be visible"),m(t.injectTarget,()=>{t.entrypoint()})))},H=()=>{let n=window.__NUXT__.state.player.audio,e=window.rfmPlus.state.audioPlayer;n&&e?(b.log("Resuming"),window.__NUXT__.state.player.audio=e,window.__NUXT__.state.player.playing=!0):!n&&e&&(b.log("Pausing"),n?.pause(),window.__NUXT__.state.player.audio=null,window.__NUXT__.state.player.playing=!1,e.pause())},U=[{name:"pathObserver",associatedFn:F,enabled:!0},{name:"playButtonClicked",associatedFn:I,enabled:!0}];m("div[data-v-733b83fc] > a > svg",n=>{q()});function q(){let n=new d("Loader");n.info("Hello from ReyfmPlus!"),U.forEach(e=>{if(e.enabled){n.info(`Loading observer: ${e.name}`);try{e.associatedFn()}catch(t){n.error(`Error while loading observer ${e.name}: ${t}`)}}}),f.forEach(e=>{if(e.enabled){n.info(`Loading plugin: ${e.name}`);try{e.awaitElementVisible&&(document.querySelector(e.awaitElementVisible)?(n.info(`Plugin ${e.name} has a dependent element ${e.awaitElementVisible} which has already been loaded. Loading plugin...`),e.entrypoint()):(n.info(`Plugin ${e.name} has a dependent element ${e.awaitElementVisible} which has not been loaded yet. Waiting for it to load...`),m(e.awaitElementVisible,e.entrypoint))),e.entrypoint()}catch(t){n.error(`Error while loading plugin ${e.name}: ${t}`)}}}),P.plugins=f,window.rfmPlus=window.rfmPlus||P,k(),h(window.location.pathname),A(window.location.pathname,h),m("a[data-v-5fde3039] > div.w-max > p.akira",e=>{let a=e.parentElement?.parentElement,i=g(e,"On Spotify","#1db954",!1,o=>{o.preventDefault(),L()});a.appendChild(i)})}function B(){window.__NUXT__.state.player.audio&&p(window.rfmPlus.state.audioPlayer);let n=location.pathname.split("/")[2],e=D[n];console.log("[REYFMPLUS] Station ID: "+e),console.log("[REYFMPLUS] Bass boost menu for station: "+n),window.__NUXT__.state.player.currentStation=e;let t=`https://listen.reyfm.de/${n}_320kbps.mp3`,a=document.createElement("div");a.style.position="fixed",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.backgroundColor="rgba(0, 0, 0, 0.5)";let i=document.createElement("div");i.style.position="absolute",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.backgroundColor="#ffffff",i.style.padding="20px",i.style.borderRadius="10px",i.style.width="80%",i.style.maxWidth="500px",i.style.height="80%",i.style.maxHeight="500px",i.style.overflow="auto",i.style.boxShadow="0 0 10px 0 rgba(0, 0, 0, 0.5)",i.textContent="REYFMPlus \u2014 Bass Boost Menu",i.style.fontSize="20px",i.style.fontWeight="bold",i.style.textAlign="center",i.style.marginBottom="20px",document.body.appendChild(a),a.appendChild(i),[{name:"Normal",description:"No bass boost",value:0},{name:"Regular Bass Boost",description:"A regular bass boost, nothing fancy",value:1},{name:"Heavy Bass Boost",description:"A heavy bass boost, for the bassheads",value:5},{name:"Bass Boost + Limiter",description:"A regular bass boost with a limiter to prevent clipping",value:3},{name:"Absolutely fucking crazy",description:"A heavy bass boost, why are you even using this",value:15}].forEach(r=>{let s=document.createElement("div");s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.marginBottom="20px",s.style.cursor="pointer";let l=document.createElement("div");l.style.fontSize="18px",l.style.fontWeight="bold",l.textContent=r.name;let c=document.createElement("div");c.style.fontSize="14px",c.style.fontWeight="normal",c.style.textAlign="center",c.textContent=r.description,s.appendChild(l),s.appendChild(c),s.addEventListener("click",()=>{Y(t,r.value),a.remove()}),i.appendChild(s)}),a.style.display="block",a.addEventListener("click",r=>{r.target===a&&a.remove()})}var D={original:1,nightlife:2,raproyal:3,usrap:4,hitsonly:5,gaming:6,houseparty:7,chillout:8,lofi:9,oldschool:10,mashup:11,charts:12,partyhard:13,bass:14,kpop:15,xmas:20};function Y(n="https://listen.reyfm.de/original_320kbps.mp3",e=1){let t=new window.AudioContext,a=new Audio;a.src=n,a.crossOrigin="anonymous";let i=t.createMediaElementSource(a),o=t.createBiquadFilter();o.type="lowshelf",o.frequency.value=1e3,o.gain.value=e,i.connect(o),o.connect(t.destination),window.__NUXT__.state.player.playing=!0,window.__NUXT__.state.player.audio&&p(a),window.rfmPlus.state.audioPlayer=a,window.rfmPlus.state.audioContext=t,window.__NUXT__.state.player.audio=a,R(a)}})();
/*! For license information please see reyfm.user.js.LEGAL.txt */
