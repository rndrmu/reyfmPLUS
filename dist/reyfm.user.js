// ==UserScript==
// @name         reyfm-plus
// @namespace    https://github.com
// @version      1.0.0
// @description  ReyFM++
// @author       
// @match        https://rey.fm/*
// @grant        none
// ==/UserScript==
(()=>{function g(n,t,e,s,a){let o=n.cloneNode(!0);return o.childNodes[0].textContent=t,o.style.backgroundColor=e,o.style.color="#ffffff",o.style.marginTop=s?"10px":"0px",o.style.paddingLeft="10px",o.style.paddingRight="10px",o.style.borderRadius="10px",o.style.fontSize="12px",o.addEventListener("click",a),o}function m(n,t){new MutationObserver((e,s)=>{let a=document.querySelectorAll(n)[0];a&&a.offsetParent!==null&&(t(a),s.disconnect())}).observe(document,{childList:!0,subtree:!0})}function k(){let n=document.querySelectorAll("p[data-v-5fde3039]")[0].textContent?.trim(),t=document.querySelectorAll("p[data-v-5fde3039]")[1].textContent?.trim(),e=`https://open.spotify.com/search/${n} ${t}`;window.open(e,"_blank")}function L(){let n=document.querySelectorAll("div.base-container")[4],e=n.childNodes[2].cloneNode(!0);e.childNodes[0].textContent="ReyfmPlus",e.querySelector("div > a > p").textContent=`A script to enhance the rey.fm experience

 Version: 1.0`,e.querySelector("div > a > p").innerHTML=e.querySelector("div > a > p").innerHTML.replace(/\n/g,"<br>"),e.querySelector("div > a").removeAttribute("href"),n.insertBefore(e,n.childNodes[5])}function p(n){window.__NUXT__.state.player.audio.pause(),window.__NUXT__.state.player.audio=null,window.__NUXT__.state.player.audio=n,window.__NUXT__.state.player.audio?.play()}function A(n){p(window.__NUXT__.state.player.audio),window.__NUXT__.state.player.audio=n,window.__NUXT__.state.player.playing=!0,window.__NUXT__.state.player.audio.play()}function R(n,t){let e=window.location.pathname;new MutationObserver((s,a)=>{window.location.pathname!==e&&(e=window.location.pathname,w(e))}).observe(document,{childList:!0,subtree:!0})}function w(n){console.log("[REYFMPLUS] New path: "+n),n.startsWith("/station/")&&m("div.name",t=>{let e=t.parentElement,s=t;s.childNodes[0].textContent=s.childNodes[0].textContent+" \u2014 ReyfmPlusEnhanced";let a=g(t,"Bass Boost Menu","#ff0000",!0,()=>{console.log("clicked boost chip"),B()});if(e.appendChild(a),!window.rfmPlus.state.bassBoostActive){let o=g(t,"Bass Boost Active (Lvl: "+window.rfmPlus.state.bassBoostLevel+")","#ff0000",!0,()=>{console.log("clicked boost active chip")});e.appendChild(o)}})}function P(n,t){let e=window.__NUXT__.state.player.audio;window.__NUXT__.state.player.currentStation=n,e.src=`https://listen.reyfm.de/${n}_${t}kbps.mp3`,e.play()}var M={original:1,nightlife:2,raproyal:3,usrap:4,hitsonly:5,gaming:6,houseparty:7,chillout:8,lofi:9,oldschool:10,mashup:11,charts:12,partyhard:13,bass:14,kpop:15,xmas:20};function y(n){return n}var C={state:{bassBoostActive:!1,bassBoostLevel:0},api:{getStation:async n=>{let t=await window.rfmPlus.api.getStations();return M[n]},getStations:async()=>new Promise((n,t)=>{let e=window.__NUXT__.state.main.data.channels;e?n(e):t("Could not get stations")}),playBoosted:async(n,t)=>{window.__NUXT__.state.player.audio&&p(window.rfmPlus.state.audioPlayer),window.rfmPlus.state.bassBoostActive=!0,P(n,t)},playOriginal:async(n,t)=>{window.__NUXT__.state.player.audio&&p(window.rfmPlus.state.audioPlayer),window.rfmPlus.state.bassBoostActive=!1,P(n,t)}},plugins:new Map};var c=class{constructor(t,e="white"){this.name=t;this.color=e}static makeTitle(t,e){return["%c %c %s ","",`background: ${t}; color: black; font-weight: bold; border-radius: 5px;`,e]}_log(t,e,s,a=""){console[t](`%c Rey.fm Plus %c %c ${this.name} ${a}`,`background: ${e}; color: black; font-weight: bold; border-radius: 5px;`,"",`background: ${this.color}; color: black; font-weight: bold; border-radius: 5px;`,...s)}log(...t){this._log("log","#a6d189",t)}info(...t){this._log("info","#a6d189",t)}error(...t){this._log("error","#e78284",t)}errorCustomFmt(t,...e){this._log("error","#e78284",e,t)}warn(...t){this._log("warn","#e5c890",t)}debug(...t){this._log("debug","#eebebe",t)}};var fe=new c("Plugins/BassBoost"),E=y({name:"Bass Boost",enabled:!0,author:"built-in",version:"1.0.0",description:"Adds a bass boost button to the player",awaitElementVisible:null,entrypoint:()=>{let n=document.createElement("button");n.className="btn btn-primary btn-sm",n.innerHTML="Bass Boost",n.addEventListener("click",()=>{let t=document.querySelector("audio");t&&(t.playbackRate=1.5)}),document.querySelector(".player-controls").appendChild(n)}});var b=(n,t,e=!1,s="info")=>{let a=document.querySelector("body"),o=document.createElement("div");o.className="fmplus notification";let r=document.querySelectorAll(".fmplus.notification");if(r.length>0){let _=r[r.length-1].getBoundingClientRect();o.style.top=`${_.bottom+15}px`}else o.style.top="0";o.style.position="fixed",o.style.right="0",o.style.width="fit-content",o.style.maxWidth="50%",o.style.minWidth="25rem",o.style.margin="0.5rem",o.style.padding="0.5rem",o.style.backgroundColor="rgba(255, 255, 255, 0.1)",o.style.backdropFilter="blur(10px)",o.style.borderRadius="0.25rem",o.style.color="#fff",o.style.textAlign="center",o.style.zIndex="9999";let i=document.createElement("h3");i.className="fmplus notification-title",i.style.top="0",i.style.left="0",i.style.margin="0",i.style.padding="0",i.style.fontSize="1.5rem",i.style.fontWeight="bold",i.innerHTML=n;let l=document.createElement("p");return l.className="fmplus notification-message",l.style.textAlign="left",l.style.margin="0",l.style.padding="0",l.innerHTML=t,o.appendChild(i),o.appendChild(l),o.animate([{transform:"translateY(-100%)"},{transform:"translateY(0)"}],{duration:500,easing:"ease-in-out"}),a.appendChild(o),e||setTimeout(()=>{o.animate([{transform:"translateY(0)"},{transform:"translateY(-100%)"}],{duration:500,easing:"ease-in-out"}).onfinish=()=>{o.remove()}},5e3),o.addEventListener("click",()=>{o.animate([{transform:"translateY(0)"},{transform:"translateY(-100%)"}],{duration:500,easing:"ease-in-out"}).onfinish=()=>{o.remove()};let d=document.querySelectorAll(".fmplus.notification"),_=Array.from(d).indexOf(o);Array.from(d).slice(_+1).forEach(v=>{let x=v.getBoundingClientRect();v.animate([{transform:`translateY(${x.top}px)`},{transform:`translateY(${x.top-65}px)`}],{duration:500,easing:"ease-in-out"}),v.style.top=`${x.top-65}px`})}),o},O=n=>{let t=document.querySelector("body"),e=document.createElement("div");e.className="fmplus toast";let s=document.querySelectorAll(".fmplus.toast");if(s.length>0){let r=s[s.length-1].getBoundingClientRect();e.style.bottom=`${r.top+10}px`,e.style.top="unset"}else e.style.bottom="0";e.style.position="fixed",e.style.left="0",e.style.width="100%",e.style.margin="1.5rem",e.style.padding="1.5rem",e.style.backgroundColor="rgba(22, 24, 25, 0.8)",e.style.backdropFilter="blur(10px)",e.style.borderRadius="0.25rem",e.style.color="#fff",e.style.textAlign="center",e.style.zIndex="9999";let a=document.createElement("p");return a.className="fmplus notification-message",a.style.textAlign="center",a.style.margin="0",a.style.padding="0",a.style.fontSize="1.5rem",a.style.fontWeight="bold",a.innerHTML=n,e.animate([{opacity:0,transform:"translateY(100%)"},{opacity:1,transform:"translateY(0)"}],{duration:500,easing:"ease-in-out"}),e.appendChild(a),t.appendChild(e),setTimeout(()=>{e.animate([{opacity:1,transform:"translateY(0)"},{opacity:0,transform:"translateY(100%)"}],{duration:500,easing:"ease-in-out"}).onfinish=()=>{e.remove()}},5e3),e.addEventListener("click",()=>{e.animate([{opacity:1,transform:"translateY(0)"},{opacity:0,transform:"translateY(100%)"}],{duration:500,easing:"ease-in-out"}).onfinish=()=>{e.remove()};let o=document.querySelectorAll(".fmplus.toast"),r=Array.from(o).indexOf(e);Array.from(o).slice(r+1).forEach(l=>{let d=l.getBoundingClientRect();l.animate([{transform:`translateY(${d.top}px)`},{transform:`translateY(${d.top+65}px)`}],{duration:500,easing:"ease-in-out"}),l.style.top=`${d.top+65}px`})}),e};var u=new c("Plugins/RankingSystem"),S=y({name:"Ranking System",enabled:!0,author:"built-in",version:"1.0.0",description:"Adds a ranking system to the player",awaitElementVisible:null,entrypoint:()=>{let n=new WebSocket("ws://localhost:8080"),t=Date.now();n.addEventListener("open",()=>{u.info("Socket connection established")}),n.addEventListener("message",a=>{switch(a.data.type){case"heartbeatACK":u.info("Received heartbeat ACK");break;case"LevelUpBroadcast":O(`User ${a.data.data.username} has leveled up to level ${a.data.data.level}!`);break;default:u.warn("Received unknown message type: %s",a.data.type);break}}),n.addEventListener("close",a=>{u.info("Socket connection closed. Code: %s, Reason: %s",a.code,a.reason),clearInterval(e),clearInterval(s)}),n.addEventListener("error",a=>{u.error(a)});let e=setInterval(()=>{u.info("Sending heartbeat"),Date.now()-t>3e4&&(u.error("Heartbeat timeout exceeded. Closing socket connection."),b("Heartbeat timeout exceeded. Closing socket connection.","",!1,"error"),n.close(4e3,"Heartbeat timeout")),n.send(JSON.stringify({type:"heartbeat",data:{timestamp:Date.now()}}))},15e3),s=setInterval(()=>{u.info("Sending play state update"),n.send(JSON.stringify({type:"PlayStateUpdate",data:{timestamp:Date.now(),discord_id:12345679e12,channel_id:"1",listening_delta:30}}))},3e4)}});var T=new c("Plugins/SleepTimer"),N=y({name:"Sleep Timer",enabled:!0,description:"Automatically stops playback after a set amount of time",version:"1.0.0",author:"built-in",pathConstraint:RegExp("/station/"),injectTarget:"div.name",entrypoint:()=>{let n=document.querySelector("div.space-y-1[data-v-5946bf68]"),t=document.createElement("button");t.className="fmplus sleep-timer-button",t.style.width="100px",t.style.margin="0.25rem",t.style.backgroundColor="#1e1e1e",t.style.color="#fff",t.style.border="1px solid #1e1e1e",t.style.borderRadius="0.25rem",t.style.padding="0.25rem",t.style.fontSize="12px",t.style.fontWeight="bold",t.style.textAlign="center",t.style.cursor="pointer",t.style.lineHeight="1.5",t.innerHTML="Sleep Timer",t.addEventListener("click",()=>{let e=document.createElement("div");e.className="fmplus sleep-timer-menu",e.style.backgroundColor="rgba(255, 255, 255, 0.2)",e.style.backdropFilter="blur(10px)",e.style.border="1px solid rgba(255, 255, 255, 0.3)",e.style.zIndex="9999",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.flexDirection="column",e.style.padding="1rem",e.style.boxSizing="border-box",e.style.cursor="pointer",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.addEventListener("click",a=>{if(a.stopPropagation(),a.target!==e){e.remove();return}}),[{label:"30 minutes",value:30},{label:"1 hour",value:60},{label:"2 hours",value:120},{label:"4 hours",value:240},{label:"8 hours",value:480},{label:"12 hours",value:720},{label:"24 hours",value:1440},{label:"Exit",value:"0"}].forEach(a=>{let o=document.createElement("button");o.style.backgroundColor="rgba(255, 255, 255, 0.2)",o.style.backdropFilter="blur(10px)",o.style.border="1px solid rgba(255, 255, 255, 0.3)",o.style.borderRadius="0.25rem",o.style.padding="0.5rem",o.style.margin="0.25rem",o.style.fontSize="12px",o.style.fontWeight="bold",o.style.textAlign="center",o.style.cursor="pointer",o.style.lineHeight="1.5",o.style.minWidth="250px",o.style.color="#fff",o.innerHTML=a.label,o.addEventListener("click",r=>{if(r.stopPropagation(),a.value==="0"){e.remove();return}T.info(`Sleep timer started for ${a.value} minutes`),X(Number(a.value)),T.info("Sleep timer menu closed"),b(`Sleep timer started for ${a.value} minutes`,"Sleep Timer",!1,"info")}),e.appendChild(o)}),document.body.appendChild(e)}),n.appendChild(t)}});async function X(n){let e=b(`Sleep timer started for ${n} minutes`,"Sleep Timer",!0,"info").querySelector("p.fmplus.notification-message"),s=n*60,a=new Date().getTime()+s*1e3,o=setInterval(()=>{if(s===0){clearInterval(o),e.innerHTML="Sleep timer engaged. Good night!",window.__NUXT__.state.player.audio.pause(),window.__NUXT__.state.player.playing=!1,window.__NUXT__.state.player.audio=null,window.rfmPlus.state.audioPlayer.pause(),window.rfmPlus.state.audioPlayer=null;return}s--,T.debug("Time remaining",s);let r=Math.floor(s/3600),i=Math.floor((s-r*3600)/60),l=s-r*3600-i*60;r<10&&(r="0"+r),i<10&&(i="0"+i),l<10&&(l="0"+l),e.innerHTML=`Time remaining: ${r}:${i}:${l}`},1e3)}var f=new Map;f.set(E.name,E);f.set(S.name,S);f.set(N.name,N);var U="div.inset-center > div.buttonShine";var h=new c("Observer"),F=()=>{let n=window.location.pathname;new MutationObserver((t,e)=>{window.location.pathname!==n&&(n=window.location.pathname,q(n))}).observe(document,{childList:!0,subtree:!0})},I=()=>{document.querySelector(U).addEventListener("click",()=>{D()})},q=n=>{h.log("New path: "+n);let t=window.rfmPlus.plugins;for(let[,e]of t)e.pathConstraint&&n.match(e.pathConstraint)&&(h.log("Enabling plugin: "+e.name),e.injectTarget&&(h.log("Waiting for element to be visible"),m(e.injectTarget,()=>{e.entrypoint()})))},D=()=>{let n=window.__NUXT__.state.player.audio,t=window.rfmPlus.state.audioPlayer;n&&t?(h.log("Resuming"),window.__NUXT__.state.player.audio=t,window.__NUXT__.state.player.playing=!0):!n&&t&&(h.log("Pausing"),n?.pause(),window.__NUXT__.state.player.audio=null,window.__NUXT__.state.player.playing=!1,t.pause())},$=[{name:"pathObserver",associatedFn:F,enabled:!0},{name:"playButtonClicked",associatedFn:I,enabled:!0}];m("div[data-v-733b83fc] > a > svg",n=>{Y()});function Y(){let n=new c("Loader");n.info("Hello from ReyfmPlus!"),$.forEach(t=>{if(t.enabled){n.info(`Loading observer: ${t.name}`);try{t.associatedFn()}catch(e){n.error(`Error while loading observer ${t.name}: ${e}`)}}}),f.forEach(t=>{if(t.enabled){n.info(`Loading plugin: ${t.name}`);try{t.awaitElementVisible&&(document.querySelector(t.awaitElementVisible)?(n.info(`Plugin ${t.name} has a dependent element ${t.awaitElementVisible} which has already been loaded. Loading plugin...`),t.entrypoint()):(n.info(`Plugin ${t.name} has a dependent element ${t.awaitElementVisible} which has not been loaded yet. Waiting for it to load...`),m(t.awaitElementVisible,t.entrypoint))),t.entrypoint()}catch(e){n.error(`Error while loading plugin ${t.name}: ${e}`)}}}),C.plugins=f,window.rfmPlus=window.rfmPlus||C,L(),w(window.location.pathname),R(window.location.pathname,w),m("a[data-v-5fde3039] > div.w-max > p.akira",t=>{let s=t.parentElement?.parentElement,a=g(t,"On Spotify","#1db954",!1,o=>{o.preventDefault(),k()});s.appendChild(a)})}function B(){window.__NUXT__.state.player.audio&&p(window.rfmPlus.state.audioPlayer);let n=location.pathname.split("/")[2],t=W[n];console.log("[REYFMPLUS] Station ID: "+t),console.log("[REYFMPLUS] Bass boost menu for station: "+n),window.__NUXT__.state.player.currentStation=t;let e=`https://listen.reyfm.de/${n}_320kbps.mp3`,s=document.createElement("div");s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.backgroundColor="rgba(0, 0, 0, 0.5)";let a=document.createElement("div");a.style.position="absolute",a.style.top="50%",a.style.left="50%",a.style.transform="translate(-50%, -50%)",a.style.backgroundColor="#ffffff",a.style.padding="20px",a.style.borderRadius="10px",a.style.width="80%",a.style.maxWidth="500px",a.style.height="80%",a.style.maxHeight="500px",a.style.overflow="auto",a.style.boxShadow="0 0 10px 0 rgba(0, 0, 0, 0.5)",a.textContent="REYFMPlus \u2014 Bass Boost Menu",a.style.fontSize="20px",a.style.fontWeight="bold",a.style.textAlign="center",a.style.marginBottom="20px",document.body.appendChild(s),s.appendChild(a),[{name:"Normal",description:"No bass boost",value:0},{name:"Regular Bass Boost",description:"A regular bass boost, nothing fancy",value:1},{name:"Heavy Bass Boost",description:"A heavy bass boost, for the bassheads",value:5},{name:"Bass Boost + Limiter",description:"A regular bass boost with a limiter to prevent clipping",value:3},{name:"Absolutely fucking crazy",description:"A heavy bass boost, why are you even using this",value:15}].forEach(r=>{let i=document.createElement("div");i.style.display="flex",i.style.flexDirection="column",i.style.alignItems="center",i.style.marginBottom="20px",i.style.cursor="pointer";let l=document.createElement("div");l.style.fontSize="18px",l.style.fontWeight="bold",l.textContent=r.name;let d=document.createElement("div");d.style.fontSize="14px",d.style.fontWeight="normal",d.style.textAlign="center",d.textContent=r.description,i.appendChild(l),i.appendChild(d),i.addEventListener("click",()=>{V(e,r.value),s.remove()}),a.appendChild(i)}),s.style.display="block",s.addEventListener("click",r=>{r.target===s&&s.remove()})}var W={original:1,nightlife:2,raproyal:3,usrap:4,hitsonly:5,gaming:6,houseparty:7,chillout:8,lofi:9,oldschool:10,mashup:11,charts:12,partyhard:13,bass:14,kpop:15,xmas:20};function V(n="https://listen.reyfm.de/original_320kbps.mp3",t=1){let e=new window.AudioContext,s=new Audio;s.src=n,s.crossOrigin="anonymous";let a=e.createMediaElementSource(s),o=e.createBiquadFilter();o.type="lowshelf",o.frequency.value=1e3,o.gain.value=t,a.connect(o),o.connect(e.destination),window.__NUXT__.state.player.playing=!0,window.__NUXT__.state.player.audio&&p(s),window.rfmPlus.state.audioPlayer=s,window.rfmPlus.state.audioContext=e,window.__NUXT__.state.player.audio=s,A(s)}})();
/*! For license information please see reyfm.user.js.LEGAL.txt */
