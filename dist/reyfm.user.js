// ==UserScript==
// @name         reyfm-plus
// @namespace    https://github.com
// @version      1.0.0
// @description  ReyFM++
// @author       
// @match        https://rey.fm/*
// @grant        none
// ==/UserScript==
(()=>{function b(t,e,o,a,n){let i=t.cloneNode(!0);return i.childNodes[0].textContent=e,i.style.backgroundColor=o,i.style.color="#ffffff",i.style.marginTop=a?"10px":"0px",i.style.paddingLeft="10px",i.style.paddingRight="10px",i.style.borderRadius="10px",i.style.fontSize="12px",i.addEventListener("click",n),i}function p(t,e){new MutationObserver((o,a)=>{let n=document.querySelectorAll(t)[0];n&&n.offsetParent!==null&&(e(n),a.disconnect())}).observe(document,{childList:!0,subtree:!0})}function T(){let t=document.querySelectorAll("p[data-v-5fde3039]")[0].textContent?.trim(),e=document.querySelectorAll("p[data-v-5fde3039]")[1].textContent?.trim(),o=`https://open.spotify.com/search/${t} ${e}`;window.open(o,"_blank")}function N(){let t=document.querySelectorAll("div.base-container")[4],o=t.childNodes[2].cloneNode(!0);o.childNodes[0].textContent="ReyfmPlus",o.querySelector("div > a > p").textContent=`A script to enhance the rey.fm experience

 Version: 1.0`,o.querySelector("div > a > p").innerHTML=o.querySelector("div > a > p").innerHTML.replace(/\n/g,"<br>"),o.querySelector("div > a").removeAttribute("href"),t.insertBefore(o,t.childNodes[5])}function c(t){window.__NUXT__.state.player.audio.pause(),window.__NUXT__.state.player.audio=null,window.__NUXT__.state.player.audio=t,window.__NUXT__.state.player.audio?.play()}var u=(t,e,o=!1)=>{let a=document.querySelector("body"),n=document.createElement("div");n.className="fmplus notification";let i=document.querySelectorAll(".fmplus.notification");if(i.length>0){let d=i[i.length-1].getBoundingClientRect();n.style.top=`${d.bottom+15}px`}else n.style.top="0";n.style.position="fixed",n.style.right="0",n.style.width="fit-content",n.style.maxWidth="50%",n.style.minWidth="25rem",n.style.margin="0.5rem",n.style.padding="0.5rem",n.style.backgroundColor="rgba(22, 24, 25, 0.8)",n.style.backdropFilter="blur(10px)",n.style.borderRadius="0.25rem",n.style.color="#fff",n.style.textAlign="center",n.style.zIndex="9999";let s=document.createElement("h3");s.className="fmplus notification-title",s.style.top="0",s.style.left="0",s.style.margin="0",s.style.padding="0",s.style.fontSize="1.5rem",s.style.fontWeight="bold",s.innerHTML=t;let r=document.createElement("p");r.className="fmplus notification-message",r.style.textAlign="left",r.style.margin="0",r.style.padding="0",r.innerHTML=e,n.appendChild(s),n.appendChild(r),n.animate([{transform:"translateY(-100%)"},{transform:"translateY(0)"}],{duration:500,easing:"ease-in-out"}),a.appendChild(n),o||setTimeout(()=>{n.animate([{transform:"translateY(0)"},{transform:"translateY(-100%)"}],{duration:500,easing:"ease-in-out"}),setTimeout(()=>{n.remove()},500)},5e3),n.addEventListener("click",()=>{n.animate([{transform:"translateY(0)"},{transform:"translateY(-100%)"}],{duration:500,easing:"ease-in-out"}),setTimeout(()=>{n.remove()},500);let m=document.querySelectorAll(".fmplus.notification"),d=Array.from(m).indexOf(n);Array.from(m).slice(d+1).forEach(w=>{let _=w.getBoundingClientRect();w.animate([{transform:`translateY(${_.top}px)`},{transform:`translateY(${_.top-65}px)`}],{duration:500,easing:"ease-in-out"}),w.style.top=`${_.top-65}px`})})},k=t=>{let e=document.querySelector("body"),o=document.createElement("div");o.className="fmplus toast";let a=document.querySelectorAll(".fmplus.toast");if(a.length>0){let s=a[a.length-1].getBoundingClientRect();o.style.bottom=`${s.top+10}px`,o.style.top="unset"}else o.style.bottom="0";o.style.position="fixed",o.style.left="0",o.style.width="100%",o.style.margin="1.5rem",o.style.padding="1.5rem",o.style.backgroundColor="rgba(22, 24, 25, 0.8)",o.style.backdropFilter="blur(10px)",o.style.borderRadius="0.25rem",o.style.color="#fff",o.style.textAlign="center",o.style.zIndex="9999";let n=document.createElement("p");n.className="fmplus notification-message",n.style.textAlign="center",n.style.margin="0",n.style.padding="0",n.style.fontSize="1.5rem",n.style.fontWeight="bold",n.innerHTML=t,o.animate([{opacity:0,transform:"translateY(100%)"},{opacity:1,transform:"translateY(0)"}],{duration:500,easing:"ease-in-out"}),o.appendChild(n),e.appendChild(o),setTimeout(()=>{o.animate([{opacity:1,transform:"translateY(0)"},{opacity:0,transform:"translateY(100%)"}],{duration:500,easing:"ease-in-out"}),setTimeout(()=>{o.remove()},500)},5e3),o.addEventListener("click",()=>{o.animate([{opacity:1,transform:"translateY(0)"},{opacity:0,transform:"translateY(100%)"}],{duration:500,easing:"ease-in-out"}),setTimeout(()=>{o.remove()},500)})};function B(t){c(window.__NUXT__.state.player.audio),window.__NUXT__.state.player.audio=t,window.__NUXT__.state.player.playing=!0,window.__NUXT__.state.player.audio.play()}function L(t,e){let o=window.location.pathname;new MutationObserver((a,n)=>{window.location.pathname!==o&&(o=window.location.pathname,h(o))}).observe(document,{childList:!0,subtree:!0})}function h(t){console.log("[REYFMPLUS] New path: "+t),t.startsWith("/station/")&&p("div.name",e=>{let o=e.parentElement,a=e;a.childNodes[0].textContent=a.childNodes[0].textContent+" \u2014 ReyfmPlusEnhanced";let n=b(e,"Bass Boost Menu","#ff0000",!0,()=>{console.log("clicked boost chip"),A()});if(o.appendChild(n),!window.rfmPlus.state.bassBoostActive){let i=b(e,"Bass Boost Active (Lvl: "+window.rfmPlus.state.bassBoostLevel+")","#ff0000",!0,()=>{console.log("clicked boost active chip"),u("Bass Boost","Bass boost is already active. Click the Bass Boost Menu chip to change the level.")});o.appendChild(i)}})}function v(t,e){let o=window.__NUXT__.state.player.audio;window.__NUXT__.state.player.currentStation=t,o.src=`https://listen.reyfm.de/${t}_${e}kbps.mp3`,o.play()}var R={original:1,nightlife:2,raproyal:3,usrap:4,hitsonly:5,gaming:6,houseparty:7,chillout:8,lofi:9,oldschool:10,mashup:11,charts:12,partyhard:13,bass:14,kpop:15,xmas:20};function y(t){return t}var x={state:{bassBoostActive:!1,bassBoostLevel:0},api:{getStation:async t=>{let e=await window.rfmPlus.api.getStations();return R[t]},getStations:async()=>new Promise((t,e)=>{let o=window.__NUXT__.state.main.data.channels;o?t(o):e("Could not get stations")}),playBoosted:async(t,e)=>{window.__NUXT__.state.player.audio&&c(window.rfmPlus.state.audioPlayer),window.rfmPlus.state.bassBoostActive=!0,v(t,e)},playOriginal:async(t,e)=>{window.__NUXT__.state.player.audio&&c(window.rfmPlus.state.audioPlayer),window.rfmPlus.state.bassBoostActive=!1,v(t,e)}},plugins:new Map};var l=class{constructor(e,o="white"){this.name=e;this.color=o}static makeTitle(e,o){return["%c %c %s ","",`background: ${e}; color: black; font-weight: bold; border-radius: 5px;`,o]}_log(e,o,a,n=""){console[e](`%c Rey.fm Plus %c %c ${this.name} ${n}`,`background: ${o}; color: black; font-weight: bold; border-radius: 5px;`,"",`background: ${this.color}; color: black; font-weight: bold; border-radius: 5px;`,...a)}log(...e){this._log("log","#a6d189",e)}info(...e){this._log("info","#a6d189",e)}error(...e){this._log("error","#e78284",e)}errorCustomFmt(e,...o){this._log("error","#e78284",o,e)}warn(...e){this._log("warn","#e5c890",e)}debug(...e){this._log("debug","#eebebe",e)}};var ue=new l("Plugins/BassBoost"),P=y({name:"Bass Boost",enabled:!0,author:"built-in",version:"1.0.0",description:"Adds a bass boost button to the player",awaitElementVisible:null,entrypoint:()=>{let t=document.createElement("button");t.className="btn btn-primary btn-sm",t.innerHTML="Bass Boost",t.addEventListener("click",()=>{let e=document.querySelector("audio");e&&(e.playbackRate=1.5)}),document.querySelector(".player-controls").appendChild(t)}});var f=new l("Plugins/RankingSystem"),S=y({name:"Ranking System",enabled:!0,author:"built-in",version:"1.0.0",description:"Adds a ranking system to the player",awaitElementVisible:null,entrypoint:()=>{let t=new WebSocket("ws://localhost:8080");t.addEventListener("open",()=>{f.info("Socket connection established"),u("Socket connection established","Socket connection established",!1)}),t.addEventListener("message",a=>{let n=JSON.parse(a.data);f.info(n)}),t.addEventListener("close",a=>{f.info("Socket connection closed. Code: %s, Reason: %s",a.code,a.reason),u("Socket connection closed","WebSocket connection terminated",!1),clearInterval(e),clearInterval(o)}),t.addEventListener("error",a=>{f.error(a),u("Socket connection error","WebSocket connection error",!1)});let e=setInterval(()=>{f.info("Sending heartbeat"),t.send(JSON.stringify({type:"heartbeat",data:{timestamp:Date.now()}}))},15e3),o=setInterval(()=>{f.info("Sending play state update"),t.send(JSON.stringify({type:"PlayStateUpdate",data:{timestamp:Date.now(),discord_id:12345679e12,channel_id:"1",listening_delta:30}}))},3e4)}});var xe=new l("Plugins/SleepTimer"),C=y({name:"Sleep Timer",enabled:!0,description:"Automatically stops playback after a set amount of time",version:"1.0.0",author:"built-in",awaitElementVisible:"div.name",entrypoint:()=>{var t=document.querySelector("div.space-y-1[data-v-5946bf68]"),e=document.createElement("button");e.className="fmplus sleep-timer-button",e.style.width="100px",e.style.margin="0.25rem",e.style.backgroundColor="#1e1e1e",e.style.color="#fff",e.style.border="1px solid #1e1e1e",e.style.borderRadius="0.25rem",e.style.padding="0.25rem",e.style.fontSize="0.75rem",e.innerHTML="Sleep Timer",e.addEventListener("click",()=>{k("Not implemented yet :("),u("Current Time",new Date().toLocaleTimeString(),!0)}),t.appendChild(e)}});var g=new Map;g.set(P.name,P);g.set(S.name,S);g.set(C.name,C);var M="div.inset-center > div.buttonShine";var E=new l("Observer"),O=()=>{let t=window.location.pathname;new MutationObserver((e,o)=>{window.location.pathname!==t&&(t=window.location.pathname,$(t))}).observe(document,{childList:!0,subtree:!0})},X=()=>{document.querySelector(M).addEventListener("click",()=>{q()})},$=t=>{if(E.log("New path: "+t),!t.startsWith("/station/"))return;let e=window.rfmPlus.plugins;for(let[o,a]of e)a.awaitElementVisible&&p(a.awaitElementVisible,()=>{a.entrypoint()})},q=()=>{let t=window.__NUXT__.state.player.audio,e=window.rfmPlus.state.audioPlayer;t&&e?(E.log("Resuming"),window.__NUXT__.state.player.audio=e,window.__NUXT__.state.player.playing=!0):!t&&e&&(E.log("Pausing"),t?.pause(),window.__NUXT__.state.player.audio=null,window.__NUXT__.state.player.playing=!1,e.pause())},U=[{name:"pathObserver",associatedFn:O,enabled:!0},{name:"playButtonClicked",associatedFn:X,enabled:!0}];p("div[data-v-733b83fc] > a > svg",t=>{F()});function F(){let t=new l("Loader");t.info("Hello from ReyfmPlus!"),U.forEach(e=>{if(e.enabled){t.info(`Loading observer: ${e.name}`);try{e.associatedFn()}catch(o){t.error(`Error while loading observer ${e.name}: ${o}`)}}}),g.forEach(e=>{if(e.enabled){t.info(`Loading plugin: ${e.name}`);try{e.awaitElementVisible&&(document.querySelector(e.awaitElementVisible)?(t.info(`Plugin ${e.name} has a dependent element ${e.awaitElementVisible} which has already been loaded. Loading plugin...`),e.entrypoint()):(t.info(`Plugin ${e.name} has a dependent element ${e.awaitElementVisible} which has not been loaded yet. Waiting for it to load...`),p(e.awaitElementVisible,e.entrypoint))),e.entrypoint()}catch(o){t.error(`Error while loading plugin ${e.name}: ${o}`)}}}),x.plugins=g,window.rfmPlus=window.rfmPlus||x,N(),h(window.location.pathname),L(window.location.pathname,h),p("a[data-v-5fde3039] > div.w-max > p.akira",e=>{let a=e.parentElement?.parentElement,n=b(e,"On Spotify","#1db954",!1,i=>{i.preventDefault(),T()});a.appendChild(n)})}function A(){window.__NUXT__.state.player.audio&&c(window.rfmPlus.state.audioPlayer);let t=location.pathname.split("/")[2],e=H[t];console.log("[REYFMPLUS] Station ID: "+e),console.log("[REYFMPLUS] Bass boost menu for station: "+t),window.__NUXT__.state.player.currentStation=e;let o=`https://listen.reyfm.de/${t}_320kbps.mp3`,a=document.createElement("div");a.style.position="fixed",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.backgroundColor="rgba(0, 0, 0, 0.5)";let n=document.createElement("div");n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.backgroundColor="#ffffff",n.style.padding="20px",n.style.borderRadius="10px",n.style.width="80%",n.style.maxWidth="500px",n.style.height="80%",n.style.maxHeight="500px",n.style.overflow="auto",n.style.boxShadow="0 0 10px 0 rgba(0, 0, 0, 0.5)",n.textContent="REYFMPlus \u2014 Bass Boost Menu",n.style.fontSize="20px",n.style.fontWeight="bold",n.style.textAlign="center",n.style.marginBottom="20px",document.body.appendChild(a),a.appendChild(n),[{name:"Normal",description:"No bass boost",value:0},{name:"Regular Bass Boost",description:"A regular bass boost, nothing fancy",value:1},{name:"Heavy Bass Boost",description:"A heavy bass boost, for the bassheads",value:5},{name:"Bass Boost + Limiter",description:"A regular bass boost with a limiter to prevent clipping",value:3},{name:"Absolutely fucking crazy",description:"A heavy bass boost, why are you even using this",value:15}].forEach(s=>{let r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.marginBottom="20px",r.style.cursor="pointer";let m=document.createElement("div");m.style.fontSize="18px",m.style.fontWeight="bold",m.textContent=s.name;let d=document.createElement("div");d.style.fontSize="14px",d.style.fontWeight="normal",d.style.textAlign="center",d.textContent=s.description,r.appendChild(m),r.appendChild(d),r.addEventListener("click",()=>{Y(o,s.value),a.remove()}),n.appendChild(r)}),a.style.display="block",a.addEventListener("click",s=>{s.target===a&&a.remove()})}var H={original:1,nightlife:2,raproyal:3,usrap:4,hitsonly:5,gaming:6,houseparty:7,chillout:8,lofi:9,oldschool:10,mashup:11,charts:12,partyhard:13,bass:14,kpop:15,xmas:20};function Y(t="https://listen.reyfm.de/original_320kbps.mp3",e=1){let o=new window.AudioContext,a=new Audio;a.src=t,a.crossOrigin="anonymous";let n=o.createMediaElementSource(a),i=o.createBiquadFilter();i.type="lowshelf",i.frequency.value=1e3,i.gain.value=e,n.connect(i),i.connect(o.destination),window.__NUXT__.state.player.playing=!0,window.__NUXT__.state.player.audio&&c(a),window.rfmPlus.state.audioPlayer=a,window.rfmPlus.state.audioContext=o,window.__NUXT__.state.player.audio=a,B(a)}})();
/*! For license information please see reyfm.user.js.LEGAL.txt */
